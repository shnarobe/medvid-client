<html>
    <head>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
       
		<script src="socket.io.js"></script>
    </head>
    <body>
        <!-- Content block 1 - student name holder-->
         <div id="studentNameContainer" style="display:none;text-align: center;background-color: darkgreen;color: white;">
               
            </div>

        <div id="ExamContentContainer" class="container">
            <!-- Content block 2 - Student Login form-->
            <div id="login"  style="display: none;">
             <h2>MedVid</h2>
                    <form id="loginForm" > 
                      <label class="form-label" for="username">Login:</label>                 
                      <input class="form-control" type="text" name="username"/>
                      <label class="form-label" for="password">Password:</label>
                      <input class="form-control"  type="password" name="password"/>
                      <input  data-step="login" type="hidden" name="details" value=""/>
                      <span class="form-text">Please enter your username and password to login.</span>
                      <button type="submit">Submit</button>
                      </form>
            </div>

            <!-- Content block 3 - Waiting screen-->
            <div id="waitingScreen" style="display: none;">
                <h2 class="text-center">Please remain focused on this screen.</h2>
            </div>

            <!-- Content block 4 - Door Note-->
            <div id="doorNoteContainer" style="display: none;">
                
            </div>

            <!-- Content block 5 - Exam content-->
             <div id="evaluationContainer" style="display: none;">

             </div>

            <!-- Content block 6 - Honour code-->
             <div id="honourCodeContainer" style="display: none;">
                <h2>Honour Code</h2>
                <p>By clicking "I agree", I acknowledge that I have read and understood the honour code.</p>
                <button id="agreeButton">I agree</button>
                </div>
          
            
        </div>
        <script>
            let backendData = {clientname: "", serverAddress: ""};
            var webSocket;
            //this function retrieves data from the main process
            (async () => {
                //get the event and data from the main process
                const data = await window.API.onReceiveData((event,data)=>{
                    // Handle the data received from the main process
                    console.log("Data from main process:",event, data,"destructured:", data.clientname,
                     data.serverAddress);
                    backendData.clientname = data.clientname;
                    backendData.serverAddress = data.serverAddress;
                    //connect to the examChildProcesses namespace
                     webSocket = io("ws://" + backendData.serverAddress + "/examChildProcesses");
                     setupWebsocket();

                });
                
            })();
            console.log("backendData:", backendData);
            var globalParticipants = [];
           
          function setupWebsocket(){  
            
            webSocket.on('connect', () => {
                console.log('WebSocket...Child process connected to server',webSocket.id);
                //send a message to the server to initiate the exam
                webSocket.emit('examChildProcess_initialize', {clientname: backendData.clientname});
            });

            webSocket.on("disconnect", () => {
                console.log("WebSocket...Child process disconnected from server", webSocket.id, "clientname", backendData.clientname);
                if(webSocket.active){
                    console.log("WebSocket...Child process disconnected temporarily but is still active and will attempt to reconnect");
                }
                else{
                    console.log("WebSocket...Child process disconnected unexpectedly and must be manually restarted");
                    //possibly send a fetch request to the parent process to restart the child process and restore the state optionally
                }
            });

            webSocket.on("examChildProcess_initialize",(data)=>{
                console.log("examChildProcess has been successfully initialized on the server",data);
               
            });

            webSocket.on("login",async(data,callback)=>{
                console.log("login data received",data);

                if(data.clientname !== backendData.clientname) {
                    console.log("Ignoring login message from another client:", data.clientname);
                    callback({ message: "failure",status:"login initiated", stepName:"login",clientname: data.clientname,
                              sessionId:data.sessionId,timeStamp:Date.now(),stepData:{recordingName:"",participants:[],evaluations:[]}
                             }); 
                    return; // Ignore messages from other clients
                }
                    console.log("Login message recived via socketio from my parent after coming from the server",data);
                    //extract content
                    const content=extractContent(data);
                            document.getElementById('login').style.display = 'block';
                            document.getElementById('loginForm').querySelector('input[name="details"]').value = data.sessionId;
                            document.getElementById('loginForm').querySelector('input[name="details"]').dataset.sessionId = data.sessionId;
                            document.getElementById('loginForm').querySelector('input[name="details"]').dataset.stepName = data.stepName;
                            document.getElementById('loginForm').querySelector('input[name="details"]').dataset.clientname = data.clientname;
                            
                            //hide all other divs
                            document.getElementById('studentNameContainer').style.display = 'none';
                            document.getElementById('waitingScreen').style.display = 'none';
                            document.getElementById('doorNoteContainer').style.display = 'none';
                            document.getElementById('evaluationContainer').style.display = 'none';
                            document.getElementById('honourCodeContainer').style.display = 'none';

                            //send ACK to server
                              callback({ message: "success",status:"login initiated", stepName:"login",clientname: data.clientname,
                              sessionId:data.sessionId,timeStamp:Date.now(),stepData:{recordingName:"",participants:[],evaluations:[]}
                             }); 
                             //send data to main to perform some action, similar to making a fetch call
                             window.API.send_to_main({
                               message: "success",
                               status: "login initiated",
                               stepName: "login",
                               clientname: data.clientname,
                               sessionId: data.sessionId,
                               timeStamp: Date.now(),
                               stepData: {
                                 recordingName: "",
                                 participants: globalParticipants,
                                 evaluations: []
                               }
                             });
                            
                             //console.log("Login response from parent",response);

            });

                  webSocket.on("Door Note",async(data,callback)=>{
                console.log("Door note data received",data);

                if(data.clientname !== backendData.clientname) {
                    console.log("Ignoring login message from another client:", data.clientname);
                    return; // Ignore messages from other clients
                }
                    console.log("Door note message recived via socketio from my parent after coming from the server",data);
                    //extract content
                    const content=extractContent(data);
                            document.getElementById('doorNoteContainer').style.display = 'block';
                            document.getElementById('doorNoteContainer').innerHTML=content;
                            document.getElementById('doorNoteContainer').dataset.sessionId = data.sessionId;
                            document.getElementById('doorNoteContainer').dataset.stepName = data.stepName;  
                            document.getElementById('doorNoteContainer').dataset.clientname = data.clientname;
                           
                            
                            //hide all other divs except the student name container
                            //document.getElementById('studentNameContainer').style.display = 'none';
                            document.getElementById('waitingScreen').style.display = 'none';
                            document.getElementById('login').style.display = 'none';
                            document.getElementById('evaluationContainer').style.display = 'none';
                            document.getElementById('honourCodeContainer').style.display = 'none';

                            //send ACK to server
                              callback({ message: "success",status:"door note launched", stepName:"Door Note",clientname: data.clientname,
                              sessionId:data.sessionId,timeStamp:Date.now(),stepData:{recordingName:"",participants:[],evaluations:[]}
                             }); 
                             //send fetch call to Parent to update state
                            const response= await AckFetch("/api/examsteps/studentDoorNote",{ message: "success",status:"door note launched", stepName:"Door Note",clientname: data.clientname,
                              sessionId:data.sessionId,timeStamp:Date.now(),stepData:{recordingName:"",participants:globalParticipants,evaluations:[]}
                             });
                             console.log("Door Note response from parent",response);

            });

               webSocket.on("Honour Code",async(data,callback)=>{
                console.log("login data received",data);
                
                if(data.clientname !== backendData.clientname) {
                    console.log("Ignoring login message from another client:", data.clientname);
                    return; // Ignore messages from other clients
                }
                    console.log("Login message recived via socketio from my parent after coming from the server",data);
                    //extract content
                    const content=extractContent(data);
                            document.getElementById('honourCodeContainer').style.display = 'block';
                            document.getElementById('honourCodeContainer').innerHTML=content;
                            document.getElementById('honourCodeContainer').dataset.sessionId = data.sessionId;
                            document.getElementById('honourCodeContainer').dataset.stepName = data.stepName;
                            document.getElementById('honourCodeContainer').dataset.clientname = data.clientname;
                           
                            
                            //hide all other divs
                            //document.getElementById('studentNameContainer').style.display = 'none';
                            document.getElementById('waitingScreen').style.display = 'none';
                            document.getElementById('login').style.display = 'none';
                            document.getElementById('evaluationContainer').style.display = 'none';
                            document.getElementById('doorNoteContainer').style.display = 'none';

                            //send ACK to server
                              callback({ message: "success",status:"honor code loaded", stepName:"Honour Code",clientname: data.clientname,
                              sessionId:data.sessionId,timeStamp:Date.now(),stepData:{recordingName:"",participants:[],evaluations:[]}
                             }); 
                             //send fetch call to Parent to update state
                            const response= await AckFetch("/api/examsteps/studentHonorCode",{ message: "success",status:"honor code loaded", stepName:"Honour Code",clientname: data.clientname,
                              sessionId:data.sessionId,timeStamp:Date.now(),stepData:{recordingName:"",participants:globalParticipants,evaluations:[]}
                             });
                             console.log("Honour Code response from parent",response);

            });

             webSocket.on("Evaluation",async(data,callback)=>{
                console.log("evalution data received",data);
                
                if(data.clientname !== 'backendData.clientname') {
                    console.log("Ignoring login message from another client:", data.clientname);
                    return; // Ignore messages from other clients
                }
                    console.log("evaluation message recived via socketio from my parent after coming from the server",data);
                    //extract content
                    const content=extractContent(data);
                            document.getElementById('evaluationContainer').style.display = 'block';
                            document.getElementById('evaluationContainer').innerHTML=content;
                            document.getElementById('evaluationContainer').dataset.sessionId = data.sessionId;
                            document.getElementById('honourCodeContainer').dataset.stepName = data.stepName;
                            document.getElementById('evaluationContainer').dataset.clientname = data.clientname;
                           
                            
                            //hide all other divs
                            //document.getElementById('studentNameContainer').style.display = 'none';
                            document.getElementById('waitingScreen').style.display = 'none';
                            document.getElementById('login').style.display = 'none';
                            document.getElementById('evaluationContainer').style.display = 'none';
                            document.getElementById('doorNoteContainer').style.display = 'none';

                            //send ACK to server
                              callback({ message: "success",status:"evaluation loaded", stepName:"Evaluation",clientname: data.clientname,
                              sessionId:data.sessionId,timeStamp:Date.now(),stepData:{recordingName:"",participants:[],evaluations:[]}
                             }); 
                             //send fetch call to Parent to update state
                            const response= await AckFetch("/api/examsteps/facultyEvaluation",{ message: "success",status:"evaluation loaded", stepName:"Evaluation",clientname: data.clientname,
                              sessionId:data.sessionId,timeStamp:Date.now(),stepData:{recordingName:"",participants:globalParticipants,evaluations:[]}
                             });  
                             
                             console.log("Evaluation response from parent",response); 
                            

            });

             webSocket.on("Start Encounter",async(data,callback)=>{
                console.log("Start Encounter data received",data);
                
                if(data.clientname !== 'backendData.clientname') {
                    console.log("Ignoring login message from another client:", data.clientname);
                    return; // Ignore messages from other clients
                }
                    console.log("Start Encounter message recived via socketio from my parent after coming from the server",data);
                    //extract content
                   /*  const content=extractContent(data);
                            document.getElementById('evaluationContainer').style.display = 'block';
                            document.getElementById('evaluationContainer').innerHTML=content;
                            document.getElementById('evaluationContainer').dataset.sessionId = data.sessionId;
                            document.getElementById('honourCodeContainer').dataset.stepName = data.stepName;
                            document.getElementById('evaluationContainer').dataset.clientname = data.clientname;
                           
                            
                            //hide all other divs
                            document.getElementById('studentNameContainer').style.display = 'none';
                            document.getElementById('waitingScreen').style.display = 'none';
                            document.getElementById('login').style.display = 'none';
                            document.getElementById('evaluationContainer').style.display = 'none';
                            document.getElementById('doorNoteContainer').style.display = 'none';
 */
                            //send ACK to server
                              callback({ message: "success",status:"Start Encounter loaded", stepName:"Start Encounter",clientname: data.clientname,
                              sessionId:data.sessionId,timeStamp:Date.now(),stepData:{recordingName:"",participants:[],evaluations:[]}
                             }); 
                             //send fetch call to Parent to update state
                            const response= await AckFetch("/api/examsteps/startEncounter",{ message: "success",status:"start encounter loaded", stepName:"Evaluation",clientname: data.clientname,
                              sessionId:data.sessionId,timeStamp:Date.now(),stepData:{recordingName:"",participants:globalParticipants,evaluations:[]}
                             });  
                             
                             console.log("start encounter response from parent",response); 
                            

            });

                            webSocket.on("Reset",async(data,callback)=>{
                                console.log("Reset data received",data);
                                //clear all data attributes
                                document.getElementById('loginForm').querySelector('input[name="details"]').value = '';
                                document.getElementById('loginForm').querySelector('input[name="details"]').dataset.sessionId = ''; 
                                document.getElementById('loginForm').querySelector('input[name="details"]').dataset.stepName = '';
                                //clear dataset of divs
                                document.getElementById('studentNameContainer').dataset="";
                                document.getElementById('waitingScreen').dataset="";
                                document.getElementById('login').dataset="";
                                document.getElementById('doorNoteContainer').dataset="";
                                document.getElementById('evaluationContainer').dataset="";
                                document.getElementById('honourCodeContainer').dataset="";

                                
                                //hide all divs
                                document.getElementById('studentNameContainer').style.display = 'none';
                                document.getElementById('waitingScreen').style.display = 'none';
                                document.getElementById('login').style.display = 'none';
                                document.getElementById('doorNoteContainer').style.display = 'none';
                                document.getElementById('evaluationContainer').style.display = 'none';
                                document.getElementById('honourCodeContainer').style.display = 'none';

                                 //send ACK to server
                              callback({ message: "success",status:"Room Reset", stepName:"Reset",clientname: data.clientname,
                              sessionId:data.sessionId,timeStamp:Date.now(),stepData:{recordingName:"",participants:[],evaluations:[]}
                             }); 
                             //send fetch call to Parent to update state
                            const response= await AckFetch("/api/examsteps/reset",{ message: "success",status:"Room Reset", stepName:"Reset",
                            clientname: data.clientname,sessionId:data.sessionId,timeStamp:Date.now(),
                            stepData:{recordingName:"",participants:globalParticipants,evaluations:[]}
                             });
                             console.log("Reset response from parent",response);
                             });
            }



            //add event listener to the form  
            document.querySelector('#loginForm').addEventListener('submit',async(event)=>{
            
                event.preventDefault();
                console.log("form submitted");
                const formData = new FormData(event.target);
                const objectData = Object.fromEntries(formData.entries());
                console.log("form data",objectData);  

                //send the data to the server via fetch
                const data=await fetch("/api/examsteps/student_login",{
                method:"POST",
                headers:{
                    "Content-Type":"application/json",
                    //"Authorization":"Bearer "+token
                },
                body:JSON.stringify({data:objectData,
                    clientname:document.getElementById('loginForm').querySelector('input[name="details"]').dataset.clientname,
                    sessionId:document.getElementById('loginForm').querySelector('input[name="details"]').dataset.sessionId,
                    step:document.getElementById('loginForm').querySelector('input[name="details"]').dataset.step})
                });

                const result=await data.json();
                console.log("result received from parent process",result);

                if(result.message=="success"){
                //if the login is successful then send a message to the client via websocket
                const sessionId=document.getElementById('loginForm').querySelector('input[name="details"]').dataset.sessionId;
                const step=document.getElementById('loginForm').querySelector('input[name="details"]').dataset.step;
                let user="";
                result.participants.forEach(participant => {
                    console.log("participant",participant);
                    user=user+participant.firstName+" "+participant.lastName+"( "+participant.username+" ) <br>";

                });
               //hide the login form
                document.getElementById('login').style.display = 'none';
                //diplay the logged in user 
                document.getElementById('studentNameContainer').innerHTML="Welcome "+user;
                document.getElementById('studentNameContainer').style.display="block";
                console.log("user",user,"sessionId",sessionId,"step",step);
                globalParticipants=result.participants;
                //send the message to the server with the user details
                webSocket.emit("login_complete",{message:"success",stepName:"login_complete",sessionId:sessionId,participants:globalParticipants,
                status:"complete",user:user,clientname:clientname});
                
                }
                else{
                    //if the login is not successful then display an error message
                   document.querySelector('#loginForm span.form-text').innerHTML="Login Failed: "+result.message+". Please try again.";
                    //document.getElementById('login').style.display = 'block';
                    //hide all other divs
                }
            });
            //add event listener to the form

            function extractContent(obj){
                let content="";
                    for(const key of Object.keys(obj)){
                         console.log("key",key,"obj[key]",obj[key]);
                         if(key.includes("stepData")){
                            for(const key1 of Object.keys(obj[key])){
                                 console.log("stepData: key",key1,"value",obj[key][key1]);
                                if(key1.includes("content")){
                                     console.log("content key",key1,"content value",obj[key][key1]);
                                    content=obj[key][key1];//get the content from the object
                        
                                 }
                            }
                        }
                    }
                    return content;
            }

            async function AckFetch(route,data){
                console.log("AckFetch called with route",route,"data",data);
                const response=await fetch(route,{
                    method:"POST",
                    headers:{
                        "Content-Type":"application/json"
                    },
                    body:JSON.stringify(data)
                });
                const result=await response.json();
                console.log("AckFetch result",result);
                return result;

            }

            
        </script>
       
    </body>
</html>